<p-toast></p-toast>

<div class="p-4 min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
    <!-- Header -->
    <div class="mb-6 flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-gray-800 dark:text-white mb-1">Dashboard Administrativo</h1>
            <p class="text-sm text-gray-500 dark:text-gray-400">KPIs y métricas clave del negocio</p>
        </div>
        <div class="flex gap-2">
            <p-button 
                [label]="showKPIs() ? 'Ver Patio' : 'Ver Métricas'" 
                [icon]="showKPIs() ? 'pi pi-th-large' : 'pi pi-chart-bar'"
                (onClick)="toggleView()"
                [outlined]="true"
                severity="secondary">
            </p-button>
        </div>
    </div>

    @if (showKPIs()) {
        <!-- Filters -->
        <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm mb-6 p-4">
            <div class="flex flex-col md:flex-row md:items-center gap-4">
                <p-selectButton 
                    [options]="periodOptions"
                    [ngModel]="selectedPeriod()"
                    (ngModelChange)="selectedPeriod.set($event); onPeriodChange()"
                    optionLabel="label"
                    optionValue="value">
                </p-selectButton>

                @if (selectedPeriod() === 'custom') {
                    <div class="flex items-center gap-2 flex-1">
                        <div class="flex-1">
                            <span class="text-xs font-semibold text-gray-500 dark:text-gray-400 block mb-1">Desde</span>
                            <p-calendar 
                                [ngModel]="customStartDate()"
                                (ngModelChange)="customStartDate.set($event); onCustomDateChange()"
                                [showIcon]="true"
                                dateFormat="dd/mm/yy"
                                styleClass="w-full p-inputtext-sm">
                            </p-calendar>
                        </div>
                        <div class="flex-1">
                            <span class="text-xs font-semibold text-gray-500 dark:text-gray-400 block mb-1">Hasta</span>
                            <p-calendar 
                                [ngModel]="customEndDate()"
                                (ngModelChange)="customEndDate.set($event); onCustomDateChange()"
                                [showIcon]="true"
                                dateFormat="dd/mm/yy"
                                styleClass="w-full p-inputtext-sm">
                            </p-calendar>
                        </div>
                    </div>
                }
            </div>
        </div>

        @if (loading()) {
            <!-- Loading Skeletons -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                @for (item of [1,2,3,4]; track item) {
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700 h-32">
                        <p-skeleton width="40%" height="1.5rem" styleClass="mb-2"></p-skeleton>
                        <p-skeleton width="80%" height="3rem"></p-skeleton>
                    </div>
                }
            </div>
        } @else if (kpis()) {
            <!-- KPI Cards Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <!-- Ganancias Netas -->
                <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm p-4 relative overflow-hidden group hover:shadow-md transition-all">
                    <div class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                        <i class="pi pi-chart-line text-6xl text-green-600 dark:text-green-400"></i>
                    </div>
                    <div class="relative z-10">
                        <p class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1">Ganancias Netas</p>
                        <h3 class="text-2xl font-bold" [ngClass]="{'text-green-600 dark:text-green-400': kpis()!.netProfit >= 0, 'text-red-600 dark:text-red-400': kpis()!.netProfit < 0}">
                            ${{ kpis()!.netProfit | number:'1.2-2' }}
                        </h3>
                        <div class="mt-2 text-xs text-gray-500 dark:text-gray-400 space-y-1 bg-gray-50 dark:bg-gray-700/50 p-2 rounded border border-gray-100 dark:border-gray-700">
                            <div class="flex justify-between border-b border-gray-200 dark:border-gray-600 pb-1 mb-1">
                                <span>Ingresos:</span> 
                                <span class="font-bold text-gray-700 dark:text-gray-300">${{ kpis()!.monthlyRevenue | number:'1.2-2' }}</span>
                            </div>
                            <div class="flex justify-between text-red-600 dark:text-red-400">
                                <span>Gastos Op.:</span> 
                                <span>-${{ kpis()!.periodExpenses | number:'1.2-2' }}</span>
                            </div>
                            <div class="flex justify-between text-red-600 dark:text-red-400">
                                <span>Mano de Obra:</span> 
                                <span>-${{ kpis()!.periodWasherEarnings | number:'1.2-2' }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ingresos Totales -->
                <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm p-4 relative overflow-hidden group hover:shadow-md transition-all">
                    <div class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                        <i class="pi pi-dollar text-6xl text-blue-600 dark:text-blue-400"></i>
                    </div>
                    <div class="relative z-10">
                        <p class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1">Ingresos del Período</p>
                        <h3 class="text-2xl font-bold text-blue-900 dark:text-blue-300">
                            ${{ kpis()!.monthlyRevenue | number:'1.2-2' }}
                        </h3>
                        <p class="mt-1 text-xs text-blue-600 dark:text-blue-300 font-medium bg-blue-50 dark:bg-blue-900/30 inline-block px-2 py-0.5 rounded border border-blue-100 dark:border-blue-800">
                            {{ kpis()!.monthlyOrders }} órdenes
                        </p>
                    </div>
                </div>

                <!-- Pendientes de Pago -->
                <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm p-4 relative overflow-hidden cursor-pointer hover:border-yellow-400 dark:hover:border-yellow-600 transition-all group"
                     [routerLink]="['/admin/washer-earnings']" [queryParams]="{status: 'PENDING'}">
                    <div class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                        <i class="pi pi-clock text-6xl text-yellow-600 dark:text-yellow-400"></i>
                    </div>
                    <div class="relative z-10">
                        <p class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1">Pendientes de Pago</p>
                        <h3 class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">
                            ${{ kpis()!.totalPendingEarnings | number:'1.2-2' }}
                        </h3>
                        <p class="mt-1 text-xs text-yellow-700 dark:text-yellow-300 font-medium bg-yellow-50 dark:bg-yellow-900/30 inline-block px-2 py-0.5 rounded border border-yellow-100 dark:border-yellow-800">
                            {{ kpis()!.totalPendingOrders }} órdenes sin pagar
                        </p>
                    </div>
                </div>

                <!-- Gastos -->
                <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm p-4 relative overflow-hidden cursor-pointer hover:border-red-400 dark:hover:border-red-600 transition-all group"
                     [routerLink]="['/admin/expenses']">
                    <div class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                        <i class="pi pi-money-bill text-6xl text-red-600 dark:text-red-400"></i>
                    </div>
                    <div class="relative z-10">
                        <p class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1">Gastos Operativos</p>
                        <h3 class="text-2xl font-bold text-red-600 dark:text-red-400">
                            ${{ kpis()!.periodExpenses | number:'1.2-2' }}
                        </h3>
                        <p class="mt-1 text-xs text-red-700 dark:text-red-300 font-medium bg-red-50 dark:bg-red-900/30 inline-block px-2 py-0.5 rounded border border-red-100 dark:border-red-800">
                            {{ kpis()!.periodExpensesCount }} registros
                        </p>
                    </div>
                </div>
            </div>

            <!-- Stats Bar -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4 flex items-center gap-3 shadow-sm">
                    <div class="w-10 h-10 rounded-full bg-blue-50 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400 border border-blue-100 dark:border-blue-800">
                        <i class="pi pi-list text-xl"></i>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 font-bold uppercase">Total Órdenes</p>
                        <p class="text-lg font-bold text-gray-800 dark:text-gray-100">{{ kpis()!.totalOrders }}</p>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4 flex items-center gap-3 shadow-sm">
                    <div class="w-10 h-10 rounded-full bg-purple-50 dark:bg-purple-900/30 flex items-center justify-center text-purple-600 dark:text-purple-400 border border-purple-100 dark:border-purple-800">
                        <i class="pi pi-users text-xl"></i>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 font-bold uppercase">Lavadores Activos</p>
                        <p class="text-lg font-bold text-gray-800 dark:text-gray-100">{{ kpis()!.activeWashers }}</p>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4 flex items-center gap-3 shadow-sm">
                    <div class="w-10 h-10 rounded-full bg-green-50 dark:bg-green-900/30 flex items-center justify-center text-green-600 dark:text-green-400 border border-green-100 dark:border-green-800">
                        <i class="pi pi-wallet text-xl"></i>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 font-bold uppercase">Pago a Lavadores</p>
                        <p class="text-lg font-bold text-gray-800 dark:text-gray-100">${{ kpis()!.periodWasherEarnings | number:'1.2-2' }}</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Top Lavadores Table -->
                <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm overflow-hidden">
                    <div class="p-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50">
                        <h3 class="text-xs font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider flex items-center gap-2">
                            <i class="pi pi-trophy text-yellow-500"></i>
                            Top 5 Rendimiento
                        </h3>
                    </div>
                    <p-table [value]="kpis()!.topWashers" styleClass="p-datatable-sm p-datatable-striped">
                        <ng-template pTemplate="header">
                            <tr class="bg-gray-50 dark:bg-gray-700">
                                <th class="w-12 text-center text-xs font-bold text-gray-600 dark:text-gray-300 uppercase">#</th>
                                <th class="text-xs font-bold text-gray-600 dark:text-gray-300 uppercase">Lavador</th>
                                <th class="text-right text-xs font-bold text-gray-600 dark:text-gray-300 uppercase">Ganado</th>
                                <th class="text-center text-xs font-bold text-gray-600 dark:text-gray-300 uppercase">Órdenes</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-washer let-i="rowIndex">
                            <tr class="text-sm hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                                <td class="text-center font-bold text-gray-500 dark:text-gray-400">{{ i + 1 }}</td>
                                <td class="font-medium text-gray-800 dark:text-gray-200">{{ washer.washerName }}</td>
                                <td class="text-right font-bold text-green-600 dark:text-green-400">${{ washer.totalEarnings | number:'1.2-2' }}</td>
                                <td class="text-center text-gray-600 dark:text-gray-400">{{ washer.totalOrders }}</td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>

                <!-- Tiempos Promedio Table -->
                <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm overflow-hidden">
                    <div class="p-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 flex justify-between items-center">
                        <h3 class="text-xs font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider flex items-center gap-2">
                            <i class="pi pi-stopwatch text-blue-500"></i>
                            Eficiencia
                        </h3>
                        @if (kpis() && kpis()!.serviceAverages && kpis()!.serviceAverages.length > 0) {
                            <p-dropdown 
                                [options]="getServiceOptions()"
                                [ngModel]="selectedServiceId()"
                                (ngModelChange)="onServiceChange($event)"
                                placeholder="Servicio"
                                optionLabel="label"
                                optionValue="value"
                                styleClass="w-48 p-inputtext-sm">
                            </p-dropdown>
                        }
                    </div>
                    
                    @if (selectedServiceId() && getWashersForSelectedService().length > 0) {
                        <div class="p-3 bg-blue-50 dark:bg-blue-900/20 text-center border-b border-blue-100 dark:border-blue-800">
                            <span class="text-xs font-bold text-blue-800 dark:text-blue-300 uppercase block">Promedio General: {{ getSelectedService()?.serviceName }}</span>
                            <span class="text-lg font-bold text-blue-900 dark:text-blue-200">{{ formatTime(getSelectedService()!.avgTimeMinutes) }}</span>
                        </div>
                        <p-table [value]="getWashersForSelectedService()" styleClass="p-datatable-sm p-datatable-striped" [scrollable]="true" scrollHeight="300px">
                            <ng-template pTemplate="header">
                                <tr class="bg-gray-50 dark:bg-gray-700">
                                    <th class="text-xs font-bold text-gray-600 dark:text-gray-300 uppercase">Lavador</th>
                                    <th class="text-right text-xs font-bold text-gray-600 dark:text-gray-300 uppercase">Tiempo</th>
                                    <th class="text-center text-xs font-bold text-gray-600 dark:text-gray-300 uppercase">Eficiencia</th>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="body" let-washer>
                                <tr class="text-sm hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                                    <td class="font-medium text-gray-800 dark:text-gray-200">{{ washer.washerName }}</td>
                                    <td class="text-right font-bold dark:text-gray-300">{{ formatTime(washer.avgTimeMinutes) }}</td>
                                    <td class="text-center">
                                        <i [class]="'pi ' + getEfficiencyIcon(washer.avgTimeMinutes, getSelectedService()?.avgTimeMinutes || 0)"
                                           [ngClass]="getEfficiencyClass(washer.avgTimeMinutes, getSelectedService()?.avgTimeMinutes || 0)"></i>
                                    </td>
                                </tr>
                            </ng-template>
                        </p-table>
                    } @else {
                        <div class="p-8 text-center text-gray-400 dark:text-gray-500">
                            <i class="pi pi-info-circle text-2xl mb-2"></i>
                            <p class="text-sm">Selecciona un servicio para ver detalles</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Servicios por Categoría -->
            @if (kpis() && kpis()!.servicesByCategory && kpis()!.servicesByCategory.length > 0) {
                <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm mb-6 p-4">
                    <h3 class="text-xs font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider mb-4 flex items-center gap-2">
                        <i class="pi pi-chart-bar text-purple-500"></i>
                        Distribución por Categoría de Vehículo
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        @for (category of getServicesByCategoryWithPercentage(); track category.categoryId) {
                            <div class="bg-gray-50 dark:bg-gray-700/50 rounded p-3 border border-gray-200 dark:border-gray-700">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="font-bold text-sm text-gray-700 dark:text-gray-200">{{ category.categoryName }}</span>
                                    <span class="text-xs font-bold px-1.5 py-0.5 rounded text-white" [style.background]="getCategoryColor(category.categoryCode)">
                                        {{ category.percentage | number:'1.0-0' }}%
                                    </span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-1.5 mb-2">
                                    <div class="h-1.5 rounded-full" [style.width.%]="category.percentage" [style.background]="getCategoryColor(category.categoryCode)"></div>
                                </div>
                                <div class="flex justify-between text-xs">
                                    <span class="text-gray-500 dark:text-gray-400">{{ category.serviceCount }} serv.</span>
                                    <span class="font-bold text-gray-800 dark:text-gray-200">${{ category.totalRevenue | number:'1.0-0' }}</span>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Gastos Recurrentes Próximos -->
            @if (upcomingRecurringExpenses().length > 0) {
                <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm overflow-hidden mb-6">
                    <div class="p-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50">
                        <h3 class="text-xs font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider flex items-center gap-2">
                            <i class="pi pi-calendar text-red-500"></i>
                            Próximos Vencimientos (Gastos)
                        </h3>
                    </div>
                    <p-table [value]="upcomingRecurringExpenses()" styleClass="p-datatable-sm p-datatable-striped">
                        <ng-template pTemplate="header">
                            <tr class="bg-gray-50 dark:bg-gray-700">
                                <th class="text-xs font-bold text-gray-600 dark:text-gray-300 uppercase">Gasto</th>
                                <th class="text-xs font-bold text-gray-600 dark:text-gray-300 uppercase">Frecuencia</th>
                                <th class="text-right text-xs font-bold text-gray-600 dark:text-gray-300 uppercase">Monto Est.</th>
                                <th class="text-right text-xs font-bold text-gray-600 dark:text-gray-300 uppercase">Vencimiento</th>
                                <th class="text-center text-xs font-bold text-gray-600 dark:text-gray-300 uppercase">Estado</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-expense>
                            <tr class="text-sm hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                                <td class="font-medium text-gray-800 dark:text-gray-200">{{ expense.description }}</td>
                                <td><p-tag [value]="getRecurrenceLabel(expense.recurrenceFrequency)" severity="info" styleClass="text-[10px] uppercase"></p-tag></td>
                                <td class="text-right font-bold text-gray-700 dark:text-gray-300">${{ expense.amountUSD | number:'1.2-2' }}</td>
                                <td class="text-right font-mono dark:text-gray-300">{{ expense.nextDueDate | date:'dd/MM/yyyy' }}</td>
                                <td class="text-center">
                                    @if (isOverdue(expense.nextDueDate)) {
                                        <p-tag value="Vencido" severity="danger" styleClass="text-[10px] uppercase font-bold"></p-tag>
                                    } @else if (isDueSoon(expense.nextDueDate)) {
                                        <p-tag value="Próximo" severity="warning" styleClass="text-[10px] uppercase font-bold"></p-tag>
                                    } @else {
                                        <p-tag value="Futuro" severity="success" styleClass="text-[10px] uppercase font-bold"></p-tag>
                                    }
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>
            }

        }
    } @else {
        <!-- Patio Dashboard -->
        <app-patio-dashboard></app-patio-dashboard>
    }
</div>