<p-toast></p-toast>

<p-dialog 
    [visible]="visible()" 
    [modal]="true"
    [style]="{width: '95vw', maxWidth: '900px'}" 
    [draggable]="false" 
    [resizable]="false"
    [closable]="false"
    (onHide)="handleClose()"
    styleClass="p-0 overflow-hidden rounded-xl process-payment-dialog">
    <!-- Header Customization -->
    <ng-template pTemplate="header">
        <div class="flex items-center justify-between w-full">
            <div class="flex flex-col">
                <span class="text-xl font-bold text-gray-900 dark:text-white">Procesar Pago</span>
                <span class="text-sm text-gray-500 dark:text-gray-400">Order #{{ order()?.id }}</span>
            </div>
            <button 
                type="button" 
                (click)="handleClose()"
                class="p-dialog-header-icon p-dialog-header-close p-link !w-8 !h-8 !p-0 flex items-center justify-center hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-400 transition-colors rounded-full"
                aria-label="Close">
                <span class="p-dialog-header-close-icon pi pi-times"></span>
            </button>
        </div>
    </ng-template>

    @if (order()) {
    <div class="flex flex-col md:flex-row gap-6 p-1 w-full bg-gray-50/50">
        
        <!-- Left Column: Form & Payments List -->
        <div class="flex-1 flex flex-col gap-6" [formGroup]="paymentForm">
            
            <!-- Monto a Pagar Section -->
            <div class="bg-white p-4 rounded-lg border border-gray-200">
                <h4 class="text-xs font-bold text-blue-900 uppercase tracking-wider mb-3">MONTO A PAGAR</h4>
                <div class="grid grid-cols-12 gap-4">
                    <div class="col-span-6">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Moneda</label>
                        <p-dropdown [options]="currencies" formControlName="currency" optionLabel="label" optionValue="value"
                            styleClass="w-full" [style]="{'width':'100%'}"></p-dropdown>
                    </div>
                    <div class="col-span-6">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Cantidad</label>
                        @if (currentCurrency() === 'VES') {
                            <div>
                                <p-inputNumber 
                                    [formControl]="amountControl" 
                                    mode="decimal" 
                                    [prefix]="'Bs. '"
                                    locale="es-VE"
                                    [minFractionDigits]="2" 
                                    [maxFractionDigits]="2" 
                                    placeholder="0,00"
                                    styleClass="w-full" 
                                    [style]="{'width':'100%'}"></p-inputNumber>
                                @if (remainingUSD() > 0.01) {
                                    <div class="text-[10px] text-gray-500 mt-1">
                                        Restante: {{ formatVES(remainingUSD() * exchangeRate()) }} 
                                        (equiv. {{ formatUSD(remainingUSD()) }})
                                    </div>
                                }
                            </div>
                        } @else {
                            <p-inputNumber 
                                [formControl]="amountControl" 
                                mode="currency" 
                                currency="USD"
                                locale="en-US"
                                [minFractionDigits]="2" 
                                [maxFractionDigits]="2" 
                                placeholder="0.00"
                                styleClass="w-full" 
                                [style]="{'width':'100%'}"></p-inputNumber>
                        }
                    </div>
                </div>
            </div>

            <!-- Método de Pago Section -->
            <div class="bg-white p-0 rounded-lg">
                <h4 class="text-xs font-bold text-gray-600 uppercase tracking-wider mb-3 pl-1">MÉTODO DE PAGO</h4>
                <div class="grid grid-cols-3 gap-3">
                    @for (method of paymentMethods; track method.value) {
                    <button type="button" 
                        class="flex flex-col items-center justify-center p-4 rounded-xl border-2 transition-all duration-200 group h-24"
                        [ngClass]="{'bg-blue-600 border-blue-600 text-white ': paymentForm.get('paymentMethod')?.value === method.value, 'bg-white border-gray-100 text-gray-500 hover:border-blue-200 hover:bg-blue-50 hover:text-blue-600': paymentForm.get('paymentMethod')?.value !== method.value}"
                        (click)="paymentForm.patchValue({paymentMethod: method.value})">
                        <i class="pi text-2xl mb-2 transition-transform group-hover:scale-110"
                            [ngClass]="{
                                'pi-money-bill': method.value === 'CASH', 
                                'pi-credit-card': method.value === 'CARD', 
                                'pi-arrow-right-arrow-left': method.value === 'TRANSFER'
                            }"></i>
                        <span class="text-xs font-bold">{{ method.label }}</span>
                    </button>
                    }
                </div>
            </div>
            
            <!-- Reference Input (Conditional) -->
            @if (paymentForm.get('paymentMethod')?.value === 'TRANSFER') {
            <div class="bg-white p-3 rounded-lg border border-gray-200">
                <label class="block text-xs font-medium text-gray-600 mb-1">Referencia</label>
                <input pInputText type="text" formControlName="reference" placeholder="Nro. Referencia"
                    class="w-full p-2 text-sm border-gray-300 rounded-md" />
            </div>
            }

            <!-- Add Payment Button -->
            <button pButton label="+ Agregar Pago" type="button"
                [disabled]="!canAddPayment()"
                (click)="addPayment()"
                class="w-full py-3 rounded-lg font-bold text-sm transition-all shadow-sm"
                [ngClass]="canAddPayment() ? 'bg-blue-600 hover:bg-blue-700 text-white border-transparent' : 'bg-gray-300 text-gray-500 border-transparent cursor-not-allowed'"></button>

            <!-- Payments List -->
            <div class="flex flex-col gap-2 mt-2">
                <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1 pl-1">ABONOS REALIZADOS</h4>
                
                @if (existingPayments().length === 0 && currentPayments().length === 0) {
                    <div class="text-center py-6 border-2 border-dashed border-gray-200 rounded-lg">
                        <p class="text-gray-400 text-sm">No hay abonos registrados</p>
                    </div>
                }

                <div class="flex flex-col gap-2 max-h-[240px] overflow-y-auto pr-1 custom-scrollbar">
                    <!-- Pagos existentes -->
                    @for (payment of existingPayments(); track payment.createdAt || $index) {
                    <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-200">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-md flex items-center justify-center border border-gray-100"
                                 [ngClass]="{'bg-green-50 text-green-600': payment.method === 'CASH', 'bg-blue-50 text-blue-600': payment.method === 'CARD', 'bg-purple-50 text-purple-600': payment.method === 'TRANSFER'}">
                                <i class="pi text-sm"
                                    [ngClass]="{'pi-money-bill': payment.method === 'CASH', 'pi-credit-card': payment.method === 'CARD', 'pi-arrow-right-arrow-left': payment.method === 'TRANSFER'}"></i>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-xs font-bold text-gray-800">
                                    {{ payment.method === 'CASH' ? 'Efectivo' : payment.method === 'CARD' ? 'Tarjeta' : 'Transferencia' }}
                                    <span class="text-[10px] text-gray-500 ml-1">(Existente)</span>
                                </span>
                                <span class="text-[10px] text-gray-500">
                                    @if (payment.createdAt) {
                                        {{ payment.createdAt | date:'short' }}
                                    } @else {
                                        {{ payment.timestamp | date:'shortTime' }}
                                    }
                                    • {{ payment.currency }}
                                </span>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="text-right">
                                @if (payment.currency === 'VES') {
                                    <div class="text-sm font-bold text-gray-900">{{ formatVES(payment.amount) }}</div>
                                    <div class="text-[10px] text-gray-400">
                                        @if (payment.amountUSD) {
                                            {{ formatUSD(payment.amountUSD) }} USD
                                        } @else {
                                            {{ formatUSD(payment.amount / payment.exchangeRate) }} USD
                                        }
                                    </div>
                                    @if (payment.reference) {
                                        <div class="text-[10px] text-gray-400">Ref: {{ payment.reference }}</div>
                                    }
                                } @else {
                                    <div class="text-sm font-bold text-gray-900">{{ formatUSD(payment.amount) }}</div>
                                }
                            </div>
                        </div>
                    </div>
                    }
                    
                    <!-- Pagos nuevos -->
                    @for (payment of currentPayments(); track $index) {
                    <div class="flex justify-between items-center bg-white p-3 rounded-lg border border-gray-200 hover:border-gray-300 hover:bg-gray-50 transition-all">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-md flex items-center justify-center border border-gray-100"
                                 [ngClass]="{'bg-green-50 text-green-600': payment.method === 'CASH', 'bg-blue-50 text-blue-600': payment.method === 'CARD', 'bg-purple-50 text-purple-600': payment.method === 'TRANSFER'}">
                                <i class="pi text-sm"
                                    [ngClass]="{'pi-money-bill': payment.method === 'CASH', 'pi-credit-card': payment.method === 'CARD', 'pi-arrow-right-arrow-left': payment.method === 'TRANSFER'}"></i>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-xs font-bold text-gray-800">
                                    {{ payment.method === 'CASH' ? 'Efectivo' : payment.method === 'CARD' ? 'Tarjeta' : 'Transferencia' }}
                                </span>
                                <span class="text-[10px] text-gray-500">{{ payment.timestamp | date:'shortTime' }} • {{ payment.currency }}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="text-right">
                                @if (payment.currency === 'VES') {
                                    <div class="text-sm font-bold text-gray-900">{{ formatVES(payment.amount) }}</div>
                                    <div class="text-[10px] text-gray-400">{{ formatUSD(payment.amount / payment.exchangeRate) }} USD</div>
                                    @if (payment.reference) {
                                        <div class="text-[10px] text-gray-400">Ref: {{ payment.reference }}</div>
                                    }
                                } @else {
                                    <div class="text-sm font-bold text-gray-900">{{ formatUSD(payment.amount) }}</div>
                                }
                            </div>
                            <button pButton icon="pi pi-trash" 
                                class="p-button-rounded p-button-text p-button-danger p-button-sm w-6 h-6"
                                (click)="removePayment($index)"></button>
                        </div>
                    </div>
                    }
                </div>
            </div>

        </div>

        <!-- Right Column: Summary Sidebar -->
        <div class="w-full md:w-80 flex-shrink-0">
            <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm h-full flex flex-col">
                <h4 class="text-xs font-bold text-blue-900 uppercase tracking-wider mb-6">RESUMEN</h4>

                <div class="space-y-4 flex-1">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Total Orden</span>
                        <span class="text-base font-bold transition-colors duration-300"
                            [ngClass]="(remainingUSD() <= 0.01 || (changeUSD() > 0.01 && confirmChangeValue())) ? 'text-green-600' : 'text-gray-900'">
                            {{ formatUSD(order()?.totalAmount) }}
                        </span>
                    </div>
                    
                    <div class="flex justify-between items-center pb-4 border-b border-gray-100">
                        <span class="text-sm text-gray-600">Total Pagado</span>
                        <span class="text-base font-bold text-green-600">{{ formatUSD(totalPaidUSD()) }}</span>
                    </div>

                    <!-- Restante / Cambio Card -->
                    <div class="mt-4 p-5 rounded-xl border transition-colors duration-300 text-center" 
                        [ngClass]="{
                            'bg-red-50 border-red-100': remainingUSD() > 0.01, 
                            'bg-yellow-50 border-yellow-200': changeUSD() > 0.01 && !confirmChangeValue(),
                            'bg-green-50 border-green-200': (changeUSD() > 0.01 && confirmChangeValue()) || (remainingUSD() <= 0.01 && changeUSD() <= 0.01)
                        }">
                        
                        @if (remainingUSD() > 0.01) {
                            <span class="text-xs font-bold text-red-500 uppercase block mb-1">RESTANTE</span>
                            <div class="text-4xl font-black text-red-600 tracking-tight">
                                {{ formatUSD(remainingUSD()) }}
                            </div>
                            <div class="text-sm text-red-400 mt-1 font-medium">
                                {{ formatVES(remainingUSD() * exchangeRate()) }}
                            </div>
                        } @else if (changeUSD() > 0.01) {
                            <span class="text-xs font-bold uppercase block mb-1"
                                [ngClass]="confirmChangeValue() ? 'text-green-600' : 'text-yellow-600'">
                                {{ confirmChangeValue() ? 'VUELTO ENTREGADO' : 'NECESITA ENTREGAR VUELTO' }}
                            </span>
                            <div class="text-4xl font-black tracking-tight"
                                [ngClass]="confirmChangeValue() ? 'text-green-600' : 'text-yellow-600'">
                                {{ formatUSD(changeUSD()) }}
                            </div>
                            <div class="text-sm mt-1 font-medium"
                                [ngClass]="confirmChangeValue() ? 'text-green-500' : 'text-yellow-600'">
                                {{ formatVES(changeUSD() * exchangeRate()) }}
                            </div>
                            <div class="mt-4 pt-3 border-t transition-colors"
                                [ngClass]="confirmChangeValue() ? 'border-green-200' : 'border-yellow-200'">
                                <div class="flex items-center justify-center gap-2 mb-3">
                                    <p-checkbox [formControl]="paymentForm.controls.confirmChange" [binary]="true" inputId="confirmChange" styleClass="mt-0.5"></p-checkbox>
                                    <label for="confirmChange" class="text-xs font-medium cursor-pointer leading-tight select-none text-left"
                                        [ngClass]="confirmChangeValue() ? 'text-green-800' : 'text-yellow-800'">
                                        Confirmar entrega de vuelto al cliente
                                    </label>
                                </div>
                                @if (confirmChangeValue()) {
                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <label class="text-xs font-semibold text-gray-700 block mb-2">
                                            Método de entrega del vuelto:
                                        </label>
                                        <div class="flex gap-2">
                                            <button 
                                                type="button"
                                                [class.bg-green-500]="changeMethodValue() === 'CASH'"
                                                [class.text-white]="changeMethodValue() === 'CASH'"
                                                [class.bg-white]="changeMethodValue() !== 'CASH'"
                                                [class.text-gray-700]="changeMethodValue() !== 'CASH'"
                                                [class.border-green-500]="changeMethodValue() === 'CASH'"
                                                [class.border-gray-300]="changeMethodValue() !== 'CASH'"
                                                class="flex-1 border-2 rounded-lg px-3 py-2 text-xs font-semibold transition-colors"
                                                (click)="paymentForm.controls.changeMethod.setValue('CASH')">
                                                <i class="pi pi-money-bill mr-1"></i>
                                                Efectivo
                                            </button>
                                            <button 
                                                type="button"
                                                [class.bg-blue-500]="changeMethodValue() === 'TRANSFER'"
                                                [class.text-white]="changeMethodValue() === 'TRANSFER'"
                                                [class.bg-white]="changeMethodValue() !== 'TRANSFER'"
                                                [class.text-gray-700]="changeMethodValue() !== 'TRANSFER'"
                                                [class.border-blue-500]="changeMethodValue() === 'TRANSFER'"
                                                [class.border-gray-300]="changeMethodValue() !== 'TRANSFER'"
                                                class="flex-1 border-2 rounded-lg px-3 py-2 text-xs font-semibold transition-colors"
                                                (click)="paymentForm.controls.changeMethod.setValue('TRANSFER')">
                                                <i class="pi pi-send mr-1"></i>
                                                Transferencia
                                            </button>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-2">
                                            @if (changeMethodValue() === 'CASH') {
                                                El vuelto se entregará físicamente en efectivo y se descontará del dinero en caja.
                                            } @else {
                                                El vuelto se entregará por transferencia bancaria. No se descontará del efectivo en caja.
                                            }
                                        </p>
                                    </div>
                                }
                            </div>
                        } @else {
                            <span class="text-xs font-bold text-green-600 uppercase block mb-1">ESTADO</span>
                            <div class="text-3xl font-black text-green-700">
                                PAGADO
                            </div>
                        }
                    </div>
                </div>

                <div class="mt-8 space-y-3">
                    <button pButton label="Cancelar" 
                        class="w-full bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 font-bold py-2.5 rounded-lg"
                        (click)="handleClose()"></button>
                        
                    @if (isOrderFullyPaid() && currentPayments().length === 0 && existingPayments().length > 0) {
                        <div class="w-full bg-green-50 border-2 border-green-200 rounded-lg p-4 text-center">
                            <i class="pi pi-check-circle text-green-600 text-2xl mb-2"></i>
                            <p class="text-sm font-bold text-green-700">Orden completamente pagada</p>
                            <p class="text-xs text-green-600 mt-1">No se requieren pagos adicionales</p>
                        </div>
                    } @else {
                        <button pButton 
                            [label]="processingPayment() ? 'Procesando...' : 'Pagar'" 
                            icon="pi pi-check"
                            [loading]="processingPayment()"
                            class="w-full bg-slate-900 hover:bg-slate-800 text-white border-transparent font-bold py-2.5 rounded-lg shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
                            [disabled]="remainingUSD() > 0.01 || (changeUSD() > 0.01 && !confirmChangeValue()) || currentPayments().length === 0" 
                            (click)="processPayment()"></button>
                    }
                </div>
            </div>
        </div>

    </div>
    }
</p-dialog>
